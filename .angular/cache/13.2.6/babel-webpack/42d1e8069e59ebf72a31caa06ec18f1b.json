{"ast":null,"code":"import { GlobalService } from '../services/global.service';\nimport { v4 as uuidv4 } from 'uuid';\nimport { HttpEventType, HttpResponse } from '@angular/common/http';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../services/product.service\";\nimport * as i2 from \"../services/category.service\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\n\nfunction NewProductComponent_div_3_div_35_option_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"option\", 22);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const cat_r5 = ctx.$implicit;\n    i0.ɵɵproperty(\"ngValue\", cat_r5);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", cat_r5.name, \" \");\n  }\n}\n\nfunction NewProductComponent_div_3_div_35_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 6)(1, \"label\", 7);\n    i0.ɵɵtext(2, \"Cat\\u00E9gorie:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"select\", 17)(4, \"option\", 18);\n    i0.ɵɵtext(5, \"-- S\\u00E9lectionner une cat\\u00E9gorie --\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, NewProductComponent_div_3_div_35_option_6_Template, 2, 2, \"option\", 19);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"button\", 20);\n    i0.ɵɵelement(8, \"span\", 21);\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngValue\", null);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r3.allCategories._embedded.categories);\n  }\n}\n\nfunction NewProductComponent_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 3)(1, \"form\", 4, 5);\n    i0.ɵɵlistener(\"ngSubmit\", function NewProductComponent_div_3_Template_form_ngSubmit_1_listener() {\n      i0.ɵɵrestoreView(_r7);\n\n      const _r2 = i0.ɵɵreference(2);\n\n      const ctx_r6 = i0.ɵɵnextContext();\n      return ctx_r6.onAddProduct(_r2.value);\n    });\n    i0.ɵɵelementStart(3, \"div\", 6)(4, \"label\", 7);\n    i0.ɵɵtext(5, \"D\\u00E9signation: \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(6, \"input\", 8);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"div\", 6)(8, \"label\", 7);\n    i0.ɵɵtext(9, \"Description\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(10, \"textarea\", 9);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"div\", 6)(12, \"label\", 7);\n    i0.ɵɵtext(13, \"Prix courant:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(14, \"input\", 10);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(15, \"div\", 6)(16, \"label\", 7);\n    i0.ɵɵtext(17, \"En promotion? \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(18, \"br\")(19, \"input\", 11);\n    i0.ɵɵelementStart(20, \"label\");\n    i0.ɵɵtext(21, \"\\u00A0 Oui\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(22, \"br\")(23, \"input\", 12);\n    i0.ɵɵelementStart(24, \"label\");\n    i0.ɵɵtext(25, \"\\u00A0 Non\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(26, \"div\", 6)(27, \"label\", 7);\n    i0.ɵɵtext(28, \"Quantit\\u00E9:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(29, \"input\", 13);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(30, \"div\", 6)(31, \"label\", 7);\n    i0.ɵɵtext(32, \"Image: \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(33, \"input\", 14);\n    i0.ɵɵlistener(\"change\", function NewProductComponent_div_3_Template_input_change_33_listener($event) {\n      i0.ɵɵrestoreView(_r7);\n      const ctx_r8 = i0.ɵɵnextContext();\n      return ctx_r8.onSelectPhotos($event);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(34);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(35, NewProductComponent_div_3_div_35_Template, 9, 2, \"div\", 15);\n    i0.ɵɵelementStart(36, \"button\", 16);\n    i0.ɵɵtext(37, \"Ajouter\");\n    i0.ɵɵelementEnd()()();\n  }\n\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(34);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r0.progress, \"% \");\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.allCategories);\n  }\n}\n\nfunction NewProductComponent_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r10 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 3)(1, \"p\")(2, \"button\", 23);\n    i0.ɵɵlistener(\"click\", function NewProductComponent_div_4_Template_button_click_2_listener() {\n      i0.ɵɵrestoreView(_r10);\n      const ctx_r9 = i0.ɵɵnextContext();\n      return ctx_r9.onNavigateToNewProduct();\n    });\n    i0.ɵɵtext(3, \"Nouveau Produit\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 6)(5, \"label\");\n    i0.ɵɵtext(6, \"ID:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"div\", 6)(9, \"label\");\n    i0.ɵɵtext(10, \"R\\u00E9r\\u00E9frence:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"div\", 6)(13, \"label\");\n    i0.ɵɵtext(14, \"Designation:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(15);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(16, \"div\", 6)(17, \"label\");\n    i0.ɵɵtext(18, \"Description:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(19);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(20, \"div\", 6)(21, \"label\");\n    i0.ɵɵtext(22, \"Prix courant:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(23);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(24, \"div\", 6)(25, \"label\");\n    i0.ɵɵtext(26, \"Quantit\\u00E9:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(27);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(28, \"div\", 6)(29, \"label\");\n    i0.ɵɵtext(30, \"Promotion:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(31);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(32, \"div\", 6)(33, \"label\");\n    i0.ɵɵtext(34, \"Disponible:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(35);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(36, \"div\", 6)(37, \"label\");\n    i0.ɵɵtext(38, \"Cat\\u00E9gorie:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(39);\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(7);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.id, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.reference, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.designation, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.description, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.currentPrice, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.quantity, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.isOnPromotion, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.savedProduct.isAvailable, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.selectedCategory.name, \"\");\n  }\n}\n\nexport let NewProductComponent = /*#__PURE__*/(() => {\n  class NewProductComponent {\n    constructor(productService, categoryService, router) {\n      this.productService = productService;\n      this.categoryService = categoryService;\n      this.router = router;\n      this.isSaved = false;\n      this._allCategories = undefined; // list des categories recuperee de la BD\n\n      this._progress = 0;\n      this._currentTimeStamp = 0;\n    }\n\n    ngOnInit() {\n      // recuperer la list des categories pr l afficher ds <select>\n      this.setAllCategories();\n    }\n\n    onAddProduct(savingFormFields) {\n      console.log(\"savingFormFields \");\n      console.log(savingFormFields);\n      this.selectedCategory = savingFormFields.productCategory; // recuperer la category choisie ds le champ <select>\n      // Noter bien que savingFormFields sera transmit au Model en format JSON comme suite {\"fieldName1\": value1, \"fieldName2\": value2}\n      //definir UUID pr la reference\n\n      let refUUID = uuidv4();\n      savingFormFields.reference = refUUID;\n      this.productService.saveProduct(GlobalService.HOST + \"/products\", savingFormFields).subscribe(response => {\n        //  console.log(\"Produit bien enregistré \");\n        this.savedProduct = response;\n        this.isSaved = true; // savedProduct contient la Category sous forme de lien non pas objet JSON\n\n        console.log(\"savedProduct \");\n        console.log(this.savedProduct);\n\n        if (savingFormFields.photoName) {\n          // uploader la photo et MAJ le nom de la photo ds la BD\n          this.onUploadPhotos(this.savedProduct.id); //console.log(savingFormFields.photoName);\n        } // associer le product vient d etre enregistre avec la category choisie ds le champ <select>\n\n\n        this.associateProductToItsCategory();\n      }, err => {\n        console.log(err);\n      });\n    } //GlobalService.HOST + \"/products/\" + this.savedProduct.id\n\n\n    patchProductPhotoName(URI, pPhotoName) {\n      this.productService.patchProduct(URI, {\n        photoName: pPhotoName\n      }).subscribe(response => {\n        // la reponse retournee par PATCH est vide\n        console.log(\"Photo name updated\");\n        console.log(response);\n      }, err => {\n        console.log(err);\n      });\n    }\n\n    associateProductToItsCategory() {\n      // 2 mtds pr recuperer les liens: soit construction manuelle ou exploitation des _links renvoyes par Spring Data Rest\n      //let UriOfCategoryOfProductToEdit = GlobalService.HOST + \"/products/\" + this.savedProduct.id + \"/category/\";\n      let UriOfCategoryOfProductToEdit = this.savedProduct._links.category.href; //e.g: …/products/2/category\n      //let UriOfNewCategory = GlobalService.HOST + \"/categories/\" + this.selectedCategory.id;\n\n      let UriOfNewCategory = this.selectedCategory._links.self.href; //e.g:  …/categories/3\n\n      console.log(\"URIOfProductToBindTo\");\n      console.log(UriOfCategoryOfProductToEdit);\n      console.log(\"URIOfCategoryToBind\");\n      console.log(UriOfNewCategory);\n      this.productService.updateProductAssociation(UriOfCategoryOfProductToEdit, UriOfNewCategory).subscribe(response => {\n        // la reponse retournee est vide\n        this.isSaved = true;\n      }, err => {\n        console.log(err);\n      });\n    }\n\n    onNavigateToNewProduct() {\n      this.isSaved = false;\n    }\n\n    onSelectPhotos(event) {\n      // récupérer ds Angular les phtotos sélectonnées par l'utilisateur ds l'explorateur\n      this.selectedPhotos = event.target.files;\n    }\n\n    onUploadPhotos(productId) {\n      this.progress = 0; // recuprer juste la premiere photo selectionnée\n\n      this.currentUploadedPhotos = this.selectedPhotos.item(0); // deleguer la tache au service\n\n      this.productService.uploadProductPhoto(this.currentUploadedPhotos, productId).subscribe(event => {\n        if (event.type === HttpEventType.UploadProgress) {\n          // definir le pourcentage de progression d'upload\n          this.progress = Math.round(100 * event.loaded / event.total);\n        } else if (event instanceof HttpResponse) {\n          // lors du retour de la response HTTP\n          // pr resoudre le probleme de rafraichissement de la photo causé par le cache\n          this.currentTimeStamp = Date.now();\n          alert(\"Photo bien chargée\");\n          console.log(\"Photo bien chargée\"); // Maj le nom de la photo ds la BD via this.savedProduct.id\n\n          this.patchProductPhotoName(GlobalService.HOST + \"/products/\" + this.savedProduct.id, String(this.savedProduct.id) + \".jpg\");\n        }\n      }, err => {\n        console.log(\"Problème de chargement de la photo: \" + JSON.parse(err.error).message);\n        ;\n      });\n    }\n\n    get allCategories() {\n      return this._allCategories;\n    } // public set categories(categories: Array<Category>) {\n    //   this._categories = categories;\n    // }\n\n\n    set allCategories(categories) {\n      this._allCategories = categories;\n    }\n\n    setAllCategories() {\n      this.categoryService.getAllCategories().subscribe(response => {\n        //this._categories = new Array<Category>();\n        this._allCategories = response;\n        console.log(this._allCategories);\n      }, err => {\n        console.log(err);\n      });\n    }\n\n    get selectedPhotos() {\n      return this._selectedPhotos;\n    }\n\n    set selectedPhotos(value) {\n      this._selectedPhotos = value;\n    }\n\n    get progress() {\n      return this._progress;\n    }\n\n    set progress(value) {\n      this._progress = value;\n    }\n\n    get currentUploadedPhotos() {\n      return this._currentUploadedPhotos;\n    }\n\n    set currentUploadedPhotos(value) {\n      this._currentUploadedPhotos = value;\n    }\n\n    get currentTimeStamp() {\n      return this._currentTimeStamp;\n    }\n\n    set currentTimeStamp(value) {\n      this._currentTimeStamp = value;\n    }\n\n  }\n\n  NewProductComponent.ɵfac = function NewProductComponent_Factory(t) {\n    return new (t || NewProductComponent)(i0.ɵɵdirectiveInject(i1.ProductService), i0.ɵɵdirectiveInject(i2.CategoryService), i0.ɵɵdirectiveInject(i3.Router));\n  };\n\n  NewProductComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: NewProductComponent,\n    selectors: [[\"app-new-product\"]],\n    decls: 5,\n    vars: 2,\n    consts: [[1, \"panel\", \"panel-default\"], [1, \"panel-heading\"], [\"class\", \"panel-body\", 4, \"ngIf\"], [1, \"panel-body\"], [3, \"ngSubmit\"], [\"savingForm\", \"ngForm\"], [1, \"form-group\"], [1, \"control-label\"], [\"type\", \"text\", \"name\", \"designation\", \"ngModel\", \"\", 1, \"form-control\"], [\"name\", \"description\", \"cols\", \"20\", \"rows\", \"6\", \"ngModel\", \"\", 1, \"form-control\"], [\"type\", \"text\", \"name\", \"currentPrice\", \"ngModel\", \"\", 1, \"form-control\"], [\"type\", \"radio\", \"name\", \"isOnPromotion\", \"value\", \"true\", \"ngModel\", \"\"], [\"type\", \"radio\", \"name\", \"isOnPromotion\", \"value\", \"false\", \"ngModel\", \"\"], [\"type\", \"number\", \"name\", \"quantity\", \"ngModel\", \"\", 1, \"form-control\"], [\"type\", \"file\", \"name\", \"photoName\", \"ngModel\", \"\", 1, \"form-control\", 3, \"change\"], [\"class\", \"form-group\", 4, \"ngIf\"], [\"type\", \"submit\", 1, \"btn\", \"btn-success\"], [\"name\", \"productCategory\", \"ngModel\", \"\", 1, \"form-control\"], [\"disabled\", \"\", 3, \"ngValue\"], [3, \"ngValue\", 4, \"ngFor\", \"ngForOf\"], [\"type\", \"button\", \"routerLink\", \"/new-category\", 1, \"btn\", \"btn-success\", \"btn-xs\"], [\"aria-hidden\", \"true\", 1, \"glyphicon\", \"glyphicon-plus\"], [3, \"ngValue\"], [1, \"btn\", \"btn-success\", 3, \"click\"]],\n    template: function NewProductComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 1);\n        i0.ɵɵtext(2, \"Cr\\u00E9er nouveau produit\");\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(3, NewProductComponent_div_3_Template, 38, 2, \"div\", 2);\n        i0.ɵɵtemplate(4, NewProductComponent_div_4_Template, 40, 9, \"div\", 2);\n        i0.ɵɵelementEnd();\n      }\n\n      if (rf & 2) {\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngIf\", !ctx.isSaved);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.isSaved == true);\n      }\n    },\n    directives: [i4.NgIf, i5.ɵNgNoValidate, i5.NgControlStatusGroup, i5.NgForm, i5.DefaultValueAccessor, i5.NgControlStatus, i5.NgModel, i5.RadioControlValueAccessor, i5.NumberValueAccessor, i5.SelectControlValueAccessor, i5.NgSelectOption, i5.ɵNgSelectMultipleOption, i4.NgForOf, i3.RouterLink],\n    styles: [\"\"]\n  });\n  return NewProductComponent;\n})();","map":null,"metadata":{},"sourceType":"module"}